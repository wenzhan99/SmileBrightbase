<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Smile Bright Dental — Manage Your Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary:#1e4b86; --primary-600:#173b6a;
      --text:#243042; --muted:#6b7a90; --bg:#f5f7fb; --card:#ffffff;
      --ring:#e5e9f3; --shadow:0 8px 24px rgba(20,40,80,.08); --radius:14px;
      --success:#10b981; --warning:#f59e0b; --error:#ef4444;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg)}
    
    /* Navigation */
    .nav{
      background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
      position:sticky;top:0;z-index:100;
    }
    .nav-inner{
      max-width:1200px;margin:0 auto;padding:14px 20px;
      display:flex;align-items:center;justify-content:space-between;
    }
    .brand{
      font-weight:800;font-size:1.3rem;color:#243042;
      text-decoration:none;
    }
    .navlinks{
      display:flex;align-items:center;gap:5px;flex:1;justify-content:center;
    }
    .nav-item{position:relative}
    .nav-link{
      display:block;padding:10px 15px;text-decoration:none;color:#243042;
      font-weight:600;border-radius:6px;transition:all 0.2s ease;cursor:pointer;
    }
    .nav-link:hover,
    .nav-link:focus{color:#1e4b86;background:rgba(30,75,134,0.05)}
    .nav-link[aria-current="page"]{color:#1e4b86}
    .nav-link.has-dropdown::after{
      content:'▾';margin-left:4px;font-size:0.75em;display:inline-block;
      transition:transform 0.2s ease;
    }
    .nav-item.active .nav-link.has-dropdown::after{transform:rotate(180deg)}
    .dropdown{
      position:absolute;top:100%;left:0;min-width:220px;background:#fff;
      border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.12);padding:8px 0;
      margin-top:8px;opacity:0;visibility:hidden;transform:translateY(-10px);
      transition:all 0.25s ease;pointer-events:none;
    }
    .nav-item:hover .dropdown,
    .nav-item:focus-within .dropdown,
    .nav-item.active .dropdown{
      opacity:1;visibility:visible;transform:translateY(0);pointer-events:auto;
    }
    .dropdown a{
      display:block;padding:10px 20px;color:#243042;text-decoration:none;
      font-weight:500;transition:all 0.15s ease;
    }
    .dropdown a:hover,
    .dropdown a:focus{background:rgba(30,75,134,0.08);color:#1e4b86;padding-left:24px}
    
    .btn{
      padding:10px 18px;border-radius:999px;border:none;background:#1e4b86;
      color:#fff;font-weight:700;cursor:pointer;transition:background 0.2s ease;
      white-space:nowrap;text-decoration:none;display:inline-block;
    }
    .btn:hover{background:#173b6a}
    .btn:disabled{background:#6c757d;cursor:not-allowed}

    /* Main Content */
    .main-content{
      padding:40px 20px;max-width:900px;margin:0 auto;
    }
    .booking-container{
      background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);
      padding:40px;margin-bottom:30px;
    }
    
    /* Header Band */
    .header-band{
      background:var(--primary);color:#fff;padding:24px 28px;
      border-radius:16px;margin-bottom:30px;
      display:flex;align-items:center;justify-content:space-between;
      flex-wrap:wrap;gap:15px;
    }
    .header-band h1{
      color:#fff;font-size:2rem;margin:0;
    }
    .header-band .breadcrumb{
      color:rgba(255,255,255,0.9);text-decoration:none;
      font-weight:600;transition:color 0.2s ease;
    }
    .header-band .breadcrumb:hover{
      color:#fff;
    }
    
    .booking-header{
      text-align:center;margin-bottom:30px;
    }
    .booking-header h1{
      color:var(--primary);font-size:2rem;margin-bottom:10px;
    }
    .booking-header p{
      color:var(--muted);font-size:1.1rem;
    }
    
    /* Status Banner */
    .status-banner{
      padding:15px 20px;border-radius:8px;margin-bottom:20px;
      font-weight:600;text-align:center;
    }
    .status-banner.success{background:#d1fae5;color:#065f46;border-left:4px solid var(--success)}
    .status-banner.error{background:#fee2e2;color:#991b1b;border-left:4px solid var(--error)}
    .status-banner.warning{background:#fef3c7;color:#92400e;border-left:4px solid var(--warning)}
    
    /* Verification Section */
    .verification-section{
      background:#f8f9fa;border-radius:8px;padding:20px;margin-bottom:30px;
      border-left:4px solid var(--primary);
    }
    .verification-section h3{
      color:var(--primary);margin-bottom:15px;font-size:1.2rem;
    }
    .verification-form{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;
      align-items:end;
    }
    
    /* Current Booking Display */
    .current-booking{
      background:#f8f9fa;border-radius:8px;padding:20px;margin-bottom:30px;
      border-left:4px solid var(--primary);
    }
    .current-booking h3{
      color:var(--primary);margin-bottom:15px;font-size:1.2rem;
    }
    .booking-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;
    }
    .booking-item{
      display:flex;flex-direction:column;
    }
    .booking-label{
      font-weight:600;color:var(--text);margin-bottom:5px;
    }
    .booking-value{
      color:var(--muted);font-size:0.95rem;
    }
    
    /* Edit Form */
    .edit-section{
      margin-bottom:30px;
    }
    .edit-section h3{
      color:var(--primary);margin-bottom:20px;font-size:1.3rem;
    }
    .form-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;
    }
    .form-group{
      display:flex;flex-direction:column;
    }
    .form-group label{
      font-weight:600;color:var(--text);margin-bottom:8px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea{
      padding:12px;border:2px solid var(--ring);border-radius:8px;
      font-size:1rem;transition:border-color 0.2s ease;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus{
      outline:none;border-color:var(--primary);
    }
    .form-group.full-width{
      grid-column:1/-1;
    }
    .form-group textarea{
      min-height:100px;resize:vertical;
    }
    
    /* Action Buttons */
    .action-buttons{
      display:flex;gap:15px;justify-content:center;margin-top:30px;
    }
    .action-button{
      padding:12px 24px;border-radius:8px;text-decoration:none;
      font-weight:600;transition:all 0.2s ease;border:none;cursor:pointer;
    }
    .action-button.primary{
      background:var(--primary);color:#fff;
    }
    .action-button.primary:hover{background:var(--primary-600)}
    .action-button.secondary{
      background:#6c757d;color:#fff;
    }
    .action-button.secondary:hover{background:#5a6268}
    .action-button:disabled{
      background:#6c757d;cursor:not-allowed;opacity:0.6;
    }
    
    /* Loading States */
    .loading{
      opacity:0.6;pointer-events:none;
    }
    .spinner{
      display:inline-block;width:20px;height:20px;border:2px solid #f3f3f3;
      border-top:2px solid var(--primary);border-radius:50%;
      animation:spin 1s linear infinite;margin-right:10px;
    }
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    
    /* Error Messages */
    .error-message{
      background:#fee;color:#c33;padding:15px;border-radius:8px;
      margin-bottom:20px;border-left:4px solid #c33;
    }
    
    @media (max-width: 768px) {
      .form-grid{
        grid-template-columns:1fr;
      }
      .booking-grid{
        grid-template-columns:1fr;
      }
      .verification-form{
        grid-template-columns:1fr;
      }
      .action-buttons{
        flex-direction:column;
      }
    }
  </style>
</head>
<body>

  <!-- ===== HEADER ===== -->
  <nav class="nav">
    <div class="nav-inner">
      <a href="../index.html" class="brand">Smile Bright Dental</a>
      
      <div class="navlinks">
        <div class="nav-item">
          <a href="../index.html" class="nav-link">Home</a>
        </div>
        
        <div class="nav-item">
          <a href="../about_us.html" class="nav-link has-dropdown" aria-haspopup="true" aria-expanded="false">
            About Us
          </a>
          <div class="dropdown" role="menu">
            <a href="../about_us.html#team" role="menuitem">Our Team</a>
            <a href="../about_us.html#mission" role="menuitem">Mission & Values</a>
            <a href="../about_us.html#careers" role="menuitem">Careers</a>
            <a href="../about_us.html#contact" role="menuitem">Contact Us</a>
          </div>
        </div>
        
        <div class="nav-item">
          <a href="../services.html" class="nav-link has-dropdown" aria-haspopup="true" aria-expanded="false">
            Services
          </a>
          <div class="dropdown" role="menu">
            <a href="../services.html#general" role="menuitem">General Dentistry</a>
            <a href="../services.html#scaling" role="menuitem">Scaling & Polishing</a>
            <a href="../services.html#braces" role="menuitem">Braces & Invisalign</a>
            <a href="../services.html#whitening" role="menuitem">Teeth Whitening</a>
            <a href="../services.html#implants" role="menuitem">Dental Implants</a>
            <a href="../services.html#wisdom" role="menuitem">Wisdom Tooth Surgery</a>
          </div>
        </div>
        
        <div class="nav-item">
          <a href="../clinics.html" class="nav-link has-dropdown" aria-haspopup="true" aria-expanded="false">
            Clinics
          </a>
          <div class="dropdown" role="menu">
            <a href="../clinics.html#locations" role="menuitem">Locations</a>
            <a href="../clinics.html#hours" role="menuitem">Opening Hours</a>
            <a href="../clinics.html#insurance" role="menuitem">Insurance & CHAS</a>
            <a href="../book_appointment.html" role="menuitem">Book Appointment</a>
          </div>
        </div>
        
        <div class="nav-item">
          <a href="../FAQ.html" class="nav-link has-dropdown" aria-expanded="false">FAQ</a>
          <div class="dropdown" role="menu">
            <a href="../FAQ.html#pricing-longevity" role="menuitem">Pricing & Longevity</a>
            <a href="../FAQ.html#processes-procedures" role="menuitem">Processes & Procedures</a>
            <a href="../FAQ.html#patient-transfers" role="menuitem">Patient Transfers</a>
            <a href="../FAQ.html#chas-dental-subsidies" role="menuitem">CHAS Dental Subsidies</a>
          </div>
        </div>
        
        <div class="nav-item">
          <a href="../book_appointment.html"><button class="btn" aria-current="page">Book Appointment</button></a>
        </div>
      </div>
    </div>
  </nav>

  <!-- ===== MAIN CONTENT ===== -->
  <div class="main-content">
    <div class="booking-container">
      <!-- Header Band -->
      <div class="header-band">
        <h1>Manage Your Booking</h1>
        <a href="schedule.html" class="breadcrumb">← Back to Schedule</a>
      </div>

      <!-- Status Banner -->
      <div id="statusBanner" class="status-banner" style="display: none;">
        <span id="statusMessage"></span>
      </div>

      <!-- Error Message -->
      <div id="errorMessage" class="error-message" style="display: none;">
        <strong>Error:</strong> <span id="errorText"></span>
      </div>

      <!-- Verification Section -->
      <div class="verification-section">
        <h3>Verify Your Booking</h3>
        <div class="verification-form">
          <div class="form-group">
            <label for="referenceId">Reference ID *</label>
            <input type="text" id="referenceId" name="referenceId" required placeholder="SB-20250101-XXXX">
          </div>
          <div class="form-group">
            <label for="email">Email (Optional)</label>
            <input type="email" id="email" name="email" placeholder="your.email@example.com">
          </div>
          <div class="form-group">
            <button type="button" id="loadBookingBtn" class="btn">Load Booking</button>
          </div>
        </div>
      </div>

      <!-- Current Booking Display -->
      <div id="currentBooking" class="current-booking" style="display: none;">
        <h3>Current Booking Details</h3>
        <div class="booking-grid">
          <div class="booking-item">
            <div class="booking-label">Reference ID</div>
            <div class="booking-value" id="displayReferenceId">-</div>
          </div>
          <div class="booking-item">
            <div class="booking-label">Status</div>
            <div class="booking-value" id="displayStatus">-</div>
          </div>
          <div class="booking-item">
            <div class="booking-label">Dentist</div>
            <div class="booking-value" id="displayDentist">-</div>
          </div>
          <div class="booking-item">
            <div class="booking-label">Clinic</div>
            <div class="booking-value" id="displayClinic">-</div>
          </div>
          <div class="booking-item">
            <div class="booking-label">Date</div>
            <div class="booking-value" id="displayDate">-</div>
          </div>
          <div class="booking-item">
            <div class="booking-label">Time</div>
            <div class="booking-value" id="displayTime">-</div>
          </div>
        </div>
      </div>

      <!-- Edit Form -->
      <div id="editForm" class="edit-section" style="display: none;">
        <h3>Update Booking Details</h3>
        <form id="updateForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="editDentist">Dentist</label>
              <select id="editDentist" name="dentistId">
                <option value="dr-chua-wen-zhan">Dr. Chua Wen Zhan</option>
                <option value="dr-lau-gwen">Dr. Lau Gwen</option>
                <option value="dr-sarah-tan">Dr. Sarah Tan</option>
                <option value="dr-james-lim">Dr. James Lim</option>
                <option value="dr-aisha-rahman">Dr. Aisha Rahman</option>
                <option value="dr-alex-lee">Dr. Alex Lee</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editClinic">Clinic</label>
              <select id="editClinic" name="clinicId">
                <option value="orchard">Orchard Clinic</option>
                <option value="marina-bay">Marina Bay Clinic</option>
                <option value="bukit-timah">Bukit Timah Clinic</option>
                <option value="tampines">Tampines Clinic</option>
                <option value="jurong">Jurong Clinic</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editService">Service</label>
              <select id="editService" name="serviceCode">
                <option value="general">General Checkup</option>
                <option value="cleaning">Teeth Cleaning</option>
                <option value="filling">Dental Filling</option>
                <option value="extraction">Tooth Extraction</option>
                <option value="braces">Braces Consultation</option>
                <option value="whitening">Teeth Whitening</option>
                <option value="implant">Dental Implant</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editDate">Date</label>
              <input type="date" id="editDate" name="dateIso" required>
            </div>
            <div class="form-group">
              <label for="editTime">Time</label>
              <input type="time" id="editTime" name="time24" required>
            </div>
            <div class="form-group">
              <label for="editEmail">Email</label>
              <input type="email" id="editEmail" name="email">
            </div>
            <div class="form-group">
              <label for="editPhone">Phone</label>
              <input type="tel" id="editPhone" name="phone" placeholder="+65 1234 5678">
            </div>
            <div class="form-group full-width">
              <label for="editNotes">Notes</label>
              <textarea id="editNotes" name="notes" placeholder="Any additional notes..."></textarea>
            </div>
          </div>
          
          <div class="action-buttons">
            <button type="submit" id="updateBtn" class="action-button primary">Update Booking</button>
            <button type="button" id="cancelBtn" class="action-button secondary">Cancel</button>
          </div>
        </form>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <a href="booking_success.html" class="action-button secondary">Back to Success Page</a>
        <a href="../book_appointment.html" class="action-button secondary">Book New Appointment</a>
      </div>
    </div>
  </div>

  <script>
    // Enhanced Dentist to Clinic Mapping with multiple clinic support
    const dentistClinicMapping = {
      'dr-chua-wen-zhan': { 
        name: 'Dr. Chua Wen Zhan', 
        clinics: [
          { clinic: 'Orchard Clinic', clinic_id: 'orchard' }
        ]
      },
      'dr-lau-gwen': { 
        name: 'Dr. Lau Gwen', 
        clinics: [
          { clinic: 'Orchard Clinic', clinic_id: 'orchard' }
        ]
      },
      'dr-sarah-tan': { 
        name: 'Dr. Sarah Tan', 
        clinics: [
          { clinic: 'Marina Bay Clinic', clinic_id: 'marina-bay' }
        ]
      },
      'dr-james-lim': { 
        name: 'Dr. James Lim', 
        clinics: [
          { clinic: 'Bukit Timah Clinic', clinic_id: 'bukit-timah' }
        ]
      },
      'dr-aisha-rahman': { 
        name: 'Dr. Aisha Rahman', 
        clinics: [
          { clinic: 'Tampines Clinic', clinic_id: 'tampines' }
        ]
      },
      'dr-alex-lee': { 
        name: 'Dr. Alex Lee', 
        clinics: [
          { clinic: 'Jurong Clinic', clinic_id: 'jurong' }
        ]
      }
    };

    const dentistNameMapping = {
      'dr-chua-wen-zhan': 'Dr. Chua Wen Zhan',
      'dr-lau-gwen': 'Dr. Lau Gwen',
      'dr-sarah-tan': 'Dr. Sarah Tan',
      'dr-james-lim': 'Dr. James Lim',
      'dr-aisha-rahman': 'Dr. Aisha Rahman',
      'dr-alex-lee': 'Dr. Alex Lee'
    };

    const serviceLabelMapping = {
      'general': 'General Checkup',
      'cleaning': 'Teeth Cleaning',
      'filling': 'Dental Filling',
      'extraction': 'Tooth Extraction',
      'braces': 'Braces Consultation',
      'whitening': 'Teeth Whitening',
      'implant': 'Dental Implant',
      'other': 'Other'
    };

    let currentBooking = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Check if reference ID is in URL
      const urlParams = new URLSearchParams(window.location.search);
      const ref = urlParams.get('ref');
      
      if (ref) {
        document.getElementById('referenceId').value = ref;
        loadBooking();
      }
    });

    // Load booking button
    document.getElementById('loadBookingBtn').addEventListener('click', loadBooking);

    function loadBooking() {
      const referenceId = document.getElementById('referenceId').value.trim();
      const email = document.getElementById('email').value.trim();
      
      if (!referenceId) {
        showError('Please enter a reference ID');
        return;
      }

      // Show loading state
      const loadBtn = document.getElementById('loadBookingBtn');
      loadBtn.disabled = true;
      loadBtn.innerHTML = '<span class="spinner"></span>Loading...';

      // Build URL
      let url = `/SmileBright/api/booking/by-ref.php?ref=${encodeURIComponent(referenceId)}`;
      if (email) {
        url += `&email=${encodeURIComponent(email)}`;
      }

      fetch(url)
        .then(async response => {
          const text = await response.text();
          let data;
          
          try {
            data = JSON.parse(text);
          } catch (e) {
            console.error('Non-JSON response:', text);
            throw new Error(`Invalid response format (status ${response.status})`);
          }
          
          if (data.ok && data.booking) {
            currentBooking = data.booking;
            displayBooking(data.booking);
            showEditForm();
            hideError();
            showStatus('Booking loaded successfully', 'success');
          } else {
            throw new Error(data.error || 'Booking not found');
          }
        })
        .catch(error => {
          console.error('Error loading booking:', error);
          showError('Failed to load booking: ' + error.message);
        })
        .finally(() => {
          loadBtn.disabled = false;
          loadBtn.innerHTML = 'Load Booking';
        });
    }

    function displayBooking(booking) {
      document.getElementById('displayReferenceId').textContent = booking.referenceId;
      document.getElementById('displayStatus').textContent = booking.status || 'scheduled';
      document.getElementById('displayDentist').textContent = booking.dentistName || 'Unknown';
      document.getElementById('displayClinic').textContent = booking.clinicName || 'Unknown';
      
      const dateValue = booking.dateIso || booking.preferred_date;
      if (dateValue) {
        const date = new Date(dateValue + 'T00:00:00');
        document.getElementById('displayDate').textContent = date.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      }
      
      const timeValue = booking.time24 || booking.preferred_time;
      if (timeValue) {
        const [hours, minutes] = timeValue.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour % 12 || 12;
        document.getElementById('displayTime').textContent = `${displayHour}:${minutes} ${ampm}`;
      }
      
      document.getElementById('currentBooking').style.display = 'block';
    }

    function showEditForm() {
      if (!currentBooking) return;

      // Populate form fields
      document.getElementById('editDentist').value = currentBooking.dentistId || 'dr-chua-wen-zhan';
      document.getElementById('editClinic').value = currentBooking.clinicId || 'orchard';
      document.getElementById('editService').value = currentBooking.serviceCode || 'general';
      document.getElementById('editDate').value = currentBooking.dateIso || currentBooking.preferred_date || '';
      document.getElementById('editTime').value = currentBooking.time24 || currentBooking.preferred_time || '';
      document.getElementById('editEmail').value = currentBooking.email || '';
      document.getElementById('editPhone').value = currentBooking.phone || '';
      document.getElementById('editNotes').value = currentBooking.notes || '';

      // Set up dentist change handler
      document.getElementById('editDentist').addEventListener('change', handleDentistChange);
      document.getElementById('editDate').addEventListener('change', handleDateChange);

      document.getElementById('editForm').style.display = 'block';
    }

    // Handle dentist change - auto-update clinic
    function handleDentistChange() {
      const dentistId = document.getElementById('editDentist').value;
      const clinicSelect = document.getElementById('editClinic');
      const mapping = dentistClinicMapping[dentistId];
      
      if (mapping && mapping.clinics) {
        // Clear existing options
        clinicSelect.innerHTML = '';
        
        // Add options for this dentist's clinics
        mapping.clinics.forEach(clinic => {
          const option = document.createElement('option');
          option.value = clinic.clinic_id;
          option.textContent = clinic.clinic;
          clinicSelect.appendChild(option);
        });
        
        // Auto-select first clinic if only one option
        if (mapping.clinics.length === 1) {
          clinicSelect.value = mapping.clinics[0].clinic_id;
        }
        
        // Refresh availability
        refreshAvailability();
      }
    }

    // Handle date change - refresh availability
    function handleDateChange() {
      refreshAvailability();
    }

    // Refresh time availability
    async function refreshAvailability() {
      const dentistId = document.getElementById('editDentist').value;
      const clinicId = document.getElementById('editClinic').value;
      const date = document.getElementById('editDate').value;
      
      if (!dentistId || !clinicId || !date) {
        return;
      }
      
      try {
        const response = await fetch(`/SmileBright/api/booking/availability.php?clinicId=${encodeURIComponent(clinicId)}&dentistId=${encodeURIComponent(dentistId)}&date=${encodeURIComponent(date)}`);
        const data = await response.json();
        
        if (data.ok && data.slots) {
          const timeSelect = document.getElementById('editTime');
          const currentValue = timeSelect.value;
          
          // Clear existing options
          timeSelect.innerHTML = '';
          
          // Add available time slots
          data.slots.forEach(time => {
            const option = document.createElement('option');
            option.value = time;
            option.textContent = time;
            timeSelect.appendChild(option);
          });
          
          // Restore previous selection if still available
          if (currentValue && data.slots.includes(currentValue)) {
            timeSelect.value = currentValue;
          }
        }
      } catch (error) {
        console.error('Error fetching availability:', error);
      }
    }

    // Update form submission
    document.getElementById('updateForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!currentBooking) {
        showError('No booking loaded');
        return;
      }

      const updateBtn = document.getElementById('updateBtn');
      updateBtn.disabled = true;
      updateBtn.innerHTML = '<span class="spinner"></span>Updating...';

      // Collect form data
      const formData = new FormData(this);
      const changes = {};
      
      // Only include changed fields
      if (formData.get('dentistId') !== currentBooking.dentistId) {
        changes.dentistId = formData.get('dentistId');
        changes.dentistName = dentistNameMapping[formData.get('dentistId')];
      }
      
      if (formData.get('clinicId') !== currentBooking.clinicId) {
        changes.clinicId = formData.get('clinicId');
        const mapping = dentistClinicMapping[formData.get('dentistId') || currentBooking.dentistId];
        changes.clinicName = mapping?.clinics?.find(c => c.clinic_id === formData.get('clinicId'))?.clinic || 'Unknown';
      }
      
      if (formData.get('serviceCode') !== currentBooking.serviceCode) {
        changes.serviceCode = formData.get('serviceCode');
        changes.serviceLabel = serviceLabelMapping[formData.get('serviceCode')];
      }
      
      if (formData.get('dateIso') !== (currentBooking.dateIso || currentBooking.preferred_date)) {
        changes.dateIso = formData.get('dateIso');
      }
      
      if (formData.get('time24') !== (currentBooking.time24 || currentBooking.preferred_time)) {
        changes.time24 = formData.get('time24');
      }
      
      if (formData.get('email') !== currentBooking.email) {
        changes.email = formData.get('email');
      }
      
      if (formData.get('phone') !== currentBooking.phone) {
        changes.phone = formData.get('phone');
      }
      
      if (formData.get('notes') !== currentBooking.notes) {
        changes.notes = formData.get('notes');
      }

      // Check if there are any changes
      if (Object.keys(changes).length === 0) {
        showStatus('No changes detected', 'warning');
        updateBtn.disabled = false;
        updateBtn.innerHTML = 'Update Booking';
        return;
      }

      // Submit update
      const updateData = {
        referenceId: currentBooking.referenceId,
        changes: changes
      };

      fetch('/SmileBright/api/booking/update.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(updateData)
      })
      .then(async response => {
        const text = await response.text();
        let data;
        
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.error('Non-JSON response:', text);
          throw new Error(`Invalid response format (status ${response.status})`);
        }
        
        if (data.ok) {
          showStatus('Booking updated successfully!', 'success');
          // Reload the booking to get updated data
          setTimeout(() => {
            loadBooking();
          }, 1000);
        } else {
          throw new Error(data.error || 'Update failed');
        }
      })
      .catch(error => {
        console.error('Error updating booking:', error);
        showError('Failed to update booking: ' + error.message);
      })
      .finally(() => {
        updateBtn.disabled = false;
        updateBtn.innerHTML = 'Update Booking';
      });
    });

    // Cancel button
    document.getElementById('cancelBtn').addEventListener('click', function() {
      document.getElementById('editForm').style.display = 'none';
    });

    function showError(message) {
      document.getElementById('errorText').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
    }

    function hideError() {
      document.getElementById('errorMessage').style.display = 'none';
    }

    function showStatus(message, type) {
      const banner = document.getElementById('statusBanner');
      const messageSpan = document.getElementById('statusMessage');
      
      banner.className = `status-banner ${type}`;
      messageSpan.textContent = message;
      banner.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        banner.style.display = 'none';
      }, 5000);
    }

    // Mobile menu toggle
    function toggleMobileMenu() {
      const navMenu = document.getElementById('navMenu');
      navMenu.classList.toggle('active');
    }
    
    // Dropdown toggle for mobile/touch devices
    function toggleDropdown(event, element) {
      if (window.innerWidth <= 900 || 'ontouchstart' in window) {
        event.preventDefault();
        const navItem = element.parentElement;
        const wasActive = navItem.classList.contains('active');
        
        document.querySelectorAll('.nav-item.active').forEach(item => {
          if (item !== navItem) {
            item.classList.remove('active');
            item.querySelector('.nav-link')?.setAttribute('aria-expanded', 'false');
          }
        });
        
        navItem.classList.toggle('active');
        element.setAttribute('aria-expanded', !wasActive);
      }
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.nav-item')) {
        document.querySelectorAll('.nav-item.active').forEach(item => {
          item.classList.remove('active');
          item.querySelector('.nav-link')?.setAttribute('aria-expanded', 'false');
        });
      }
    });
  </script>
</body>
</html>
