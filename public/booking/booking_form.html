<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Smile Bright Dental — Complete Your Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../css/footer.css" />
  <style>
    :root{
      --primary:#1e4b86; --primary-600:#173b6a;
      --text:#243042; --muted:#6b7a90; --bg:#f5f7fb; --card:#ffffff;
      --ring:#e5e9f3; --shadow:0 8px 24px rgba(20,40,80,.08); --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg)}
    
    /* Navigation */
    .nav{
      background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
      position:sticky;top:0;z-index:100;
    }
    .nav-inner{
      max-width:1200px;margin:0 auto;padding:14px 20px;
      display:flex;align-items:center;justify-content:space-between;
    }
    .brand{
      font-weight:800;font-size:1.3rem;color:#243042;
      text-decoration:none;
    }
    .navlinks{
      display:flex;align-items:center;gap:5px;flex:1;justify-content:center;
    }
    .nav-item{position:relative}
    .nav-link{
      display:block;padding:10px 15px;text-decoration:none;color:#243042;
      font-weight:600;border-radius:6px;transition:all 0.2s ease;cursor:pointer;
    }
    .nav-link:hover,
    .nav-link:focus{color:#1e4b86;background:rgba(30,75,134,0.05)}
    .nav-link[aria-current="page"]{color:#1e4b86}
    .nav-link.has-dropdown::after{
      content:'▾';margin-left:4px;font-size:0.75em;display:inline-block;
      transition:transform 0.2s ease;
    }
    .nav-item.active .nav-link.has-dropdown::after{transform:rotate(180deg)}
    .dropdown{
      position:absolute;top:100%;left:0;min-width:220px;background:#fff;
      border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.12);padding:8px 0;
      margin-top:8px;opacity:0;visibility:hidden;transform:translateY(-10px);
      transition:all 0.25s ease;pointer-events:none;
    }
    .nav-item:hover .dropdown,
    .nav-item:focus-within .dropdown,
    .nav-item.active .dropdown{
      opacity:1;visibility:visible;transform:translateY(0);pointer-events:auto;
    }
    .dropdown a{
      display:block;padding:10px 20px;color:#243042;text-decoration:none;
      font-weight:500;transition:all 0.15s ease;
    }
    .dropdown a:hover,
    .dropdown a:focus{background:rgba(30,75,134,0.08);color:#1e4b86;padding-left:24px}
    
    .btn{
      padding:10px 18px;border-radius:999px;border:none;background:#1e4b86;
      color:#fff;font-weight:700;cursor:pointer;transition:background 0.2s ease;
      white-space:nowrap;text-decoration:none;display:inline-block;
    }
    .btn:hover{background:#173b6a}

    /* Main Content */
    .main-content{
      padding:40px 20px;max-width:800px;margin:0 auto;
    }
    .booking-container{
      background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);
      padding:40px;margin-bottom:30px;
    }
    .booking-header{
      background: var(--primary);
      color: #ffffff;
      border-radius: var(--radius);
      padding: 24px 28px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      text-align: center;
    }
    .booking-header h1{
      color: #ffffff;
      font-size: 2rem;
      margin-bottom: 10px;
    }
    .booking-header p{
      color: #e8eef7;
      font-size: 1.1rem;
    }
    .selection-summary{
      background:#f8f9fa;border-radius:8px;padding:20px;margin-bottom:30px;
      border-left:4px solid var(--primary);
    }
    .selection-summary h3{
      color:var(--primary);margin-bottom:15px;font-size:1.2rem;
    }
    .selection-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;
    }
    .selection-item{
      display:flex;flex-direction:column;
    }
    .selection-label{
      font-weight:600;color:var(--text);margin-bottom:5px;
    }
    .selection-value{
      color:var(--muted);font-size:0.95rem;
    }
    .form-section{
      margin-bottom:30px;
    }
    .form-section h3{
      color:var(--primary);margin-bottom:20px;font-size:1.3rem;
    }
    .form-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;
    }
    .form-group{
      display:flex;flex-direction:column;
    }
    .form-group label{
      font-weight:600;color:var(--text);margin-bottom:8px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea{
      padding:12px;border:2px solid var(--ring);border-radius:8px;
      font-size:1rem;transition:border-color 0.2s ease;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus{
      outline:none;border-color:var(--primary);
    }
    .form-group.full-width{
      grid-column:1/-1;
    }
    .form-group textarea{
      min-height:100px;resize:vertical;
    }
    .checkbox-group{
      display:flex;align-items:flex-start;gap:10px;margin-top:20px;
    }
    .checkbox-group input[type="checkbox"]{
      margin-top:2px;
    }
    .checkbox-group label{
      font-size:0.95rem;color:var(--muted);line-height:1.4;
    }
    .submit-section{
      text-align:center;margin-top:30px;
    }
    .submit-btn{
      background:var(--primary);color:#fff;padding:15px 40px;
      border:none;border-radius:999px;font-size:1.1rem;font-weight:700;
      cursor:pointer;transition:background 0.2s ease;
      width:100%;max-width:320px;
    }
    .submit-btn:hover{background:var(--primary-600)}
    .submit-btn:disabled{
      background:#6c757d;cursor:not-allowed;
    }
    .error-message{
      background:#fee;color:#c33;padding:15px;border-radius:8px;
      margin-bottom:20px;border-left:4px solid #c33;
    }
    .back-link{
      color:var(--primary);text-decoration:none;font-weight:600;
      display:inline-flex;align-items:center;gap:5px;margin-bottom:20px;
    }
    .back-link:hover{text-decoration:underline}
    
    
    @media (max-width: 768px) {
      .form-grid{
        grid-template-columns:1fr;
      }
      .selection-grid{
        grid-template-columns:1fr;
      }
    }
  </style>
</head>
<body>

  <!-- ===== HEADER ===== -->
  <nav class="nav">
    <div class="nav-inner">
      <a href="../index.html" class="brand">Smile Bright Dental</a>
      
      <div class="navlinks">
        <div class="nav-item">
          <a href="../index.html" class="nav-link">Home</a>
        </div>
        
        <div class="nav-item">
          <a href="../about_us.html" class="nav-link has-dropdown" aria-haspopup="true" aria-expanded="false">
            About Us
          </a>
          <div class="dropdown" role="menu">
            <a href="../about_us.html#team" role="menuitem">Our Team</a>
            <a href="../about_us.html#mission" role="menuitem">Mission & Values</a>
            <a href="../about_us.html#careers" role="menuitem">Careers</a>
            <a href="../about_us.html#contact" role="menuitem">Contact Us</a>
          </div>
        </div>
        
        <div class="nav-item">
          <a href="../services.html" class="nav-link has-dropdown" aria-haspopup="true" aria-expanded="false">
            Services
          </a>
          <div class="dropdown" role="menu">
            <a href="../services.html#general" role="menuitem">General Dentistry</a>
            <a href="../services.html#scaling" role="menuitem">Scaling & Polishing</a>
            <a href="../services.html#braces" role="menuitem">Braces & Invisalign</a>
            <a href="../services.html#whitening" role="menuitem">Teeth Whitening</a>
            <a href="../services.html#implants" role="menuitem">Dental Implants</a>
            <a href="../services.html#wisdom" role="menuitem">Wisdom Tooth Surgery</a>
          </div>
        </div>
        
        <div class="nav-item">
          <a href="../clinics.html" class="nav-link has-dropdown" aria-haspopup="true" aria-expanded="false">
            Clinics
          </a>
          <div class="dropdown" role="menu">
            <a href="../clinics.html#locations" role="menuitem">Locations</a>
            <a href="../clinics.html#hours" role="menuitem">Opening Hours</a>
            <a href="../clinics.html#insurance" role="menuitem">Insurance & CHAS</a>
            <a href="../book_appointment.html" role="menuitem">Book Appointment</a>
          </div>
        </div>
        
        <div class="nav-item">
          <a href="../FAQ.html" class="nav-link has-dropdown" aria-expanded="false">FAQ</a>
          <div class="dropdown" role="menu">
            <a href="../FAQ.html#pricing-longevity" role="menuitem">Pricing & Longevity</a>
            <a href="../FAQ.html#processes-procedures" role="menuitem">Processes & Procedures</a>
            <a href="../FAQ.html#patient-transfers" role="menuitem">Patient Transfers</a>
            <a href="../FAQ.html#chas-dental-subsidies" role="menuitem">CHAS Dental Subsidies</a>
          </div>
        </div>
        
        <div class="nav-item">
          <a href="../book_appointment.html"><button class="btn" aria-current="page">Book Appointment</button></a>
        </div>
      </div>
    </div>
  </nav>

  <!-- ===== MAIN CONTENT ===== -->
  <div class="main-content">
    <div class="booking-container">
      <a href="schedule.html" class="back-link">← Back to Schedule</a>
      
      <div class="booking-header">
        <h1>Complete Your Booking</h1>
        <p>Please provide your details to confirm your appointment</p>
      </div>


      <div id="errorMessage" class="error-message" style="display: none;">
        <strong>Missing Information:</strong> <span id="errorText"></span>
      </div>

      <!-- Appointment Details Section (Read-only) -->
      <div class="selection-summary">
        <h3>Appointment Details</h3>
        <div class="selection-grid">
          <div class="selection-item">
            <div class="selection-label">Dentist</div>
            <div class="selection-value" id="selectedDentist">Loading...</div>
          </div>
          <div class="selection-item">
            <div class="selection-label">Date</div>
            <div class="selection-value" id="selectedDate">Loading...</div>
          </div>
          <div class="selection-item">
            <div class="selection-label">Time</div>
            <div class="selection-value" id="selectedTime">Loading...</div>
          </div>
          <div class="selection-item">
            <div class="selection-label">Clinic</div>
            <div class="selection-value" id="selectedClinic">Loading...</div>
          </div>
        </div>
      </div>

      <form id="bookingForm">
        <!-- Hidden fields for booking data -->
        <input type="hidden" id="dentistId" name="dentistId" value="">
        <input type="hidden" id="dentistName" name="dentistName" value="">
        <input type="hidden" id="clinicId" name="clinicId" value="">
        <input type="hidden" id="clinicName" name="clinicName" value="">
        <input type="hidden" id="appointmentDate" name="appointmentDate" value="">
        <input type="hidden" id="appointmentTime" name="appointmentTime" value="">

        <!-- Personal Information Section -->
        <div class="form-section">
          <h3>Personal Information</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="firstName">First Name *</label>
              <input type="text" id="firstName" name="firstName" required>
            </div>
            <div class="form-group">
              <label for="lastName">Last Name *</label>
              <input type="text" id="lastName" name="lastName" required>
            </div>
            <div class="form-group">
              <label for="email">Email Address *</label>
              <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
              <label for="phone">Phone Number *</label>
              <input type="tel" id="phone" name="phone" required placeholder="+65 1234 5678">
            </div>
          </div>
        </div>

        <!-- Additional Information Section -->
        <div class="form-section">
          <h3>Additional Information</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="service">Service Required</label>
              <select id="service" name="service">
                <option value="general">General Checkup</option>
                <option value="cleaning">Teeth Cleaning</option>
                <option value="filling">Dental Filling</option>
                <option value="extraction">Tooth Extraction</option>
                <option value="braces">Braces Consultation</option>
                <option value="whitening">Teeth Whitening</option>
                <option value="implant">Dental Implant</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label for="experience">Previous Dental Experience</label>
              <select id="experience" name="experience">
                <option value="first-time">First time patient</option>
                <option value="regular">Regular patient</option>
                <option value="returning">Returning patient</option>
              </select>
            </div>
            <div class="form-group full-width">
              <label for="notes">Additional Notes</label>
              <textarea id="notes" name="notes" placeholder="Any specific concerns or requests..."></textarea>
            </div>
          </div>
        </div>

        <!-- Consent Section -->
        <div class="form-section">
          <div class="checkbox-group">
            <input type="checkbox" id="privacy" name="privacy" required>
            <label for="privacy">I agree to the privacy policy and consent to the collection and use of my personal information.</label>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="terms" name="terms" required>
            <label for="terms">I agree to the terms and conditions and understand the cancellation policy.</label>
          </div>
        </div>

        <div class="submit-section">
          <button type="submit" class="submit-btn" id="submitBtn" disabled>Confirm Booking</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Dentist to Clinic Mapping
    const dentistClinicMapping = {
      'Dr. Chua Wen Zhan': { clinic: 'Orchard Clinic', clinic_id: 'orchard-clinic' },
      'Dr. Lau Gwen': { clinic: 'Orchard Clinic', clinic_id: 'orchard-clinic' },
      'Dr. Sarah Tan': { clinic: 'Marina Bay Clinic', clinic_id: 'marina-bay-clinic' },
      'Dr. James Lim': { clinic: 'Bukit Timah Clinic', clinic_id: 'bukit-timah-clinic' },
      'Dr. Aisha Rahman': { clinic: 'Tampines Clinic', clinic_id: 'tampines-clinic' },
      'Dr. Alex Lee': { clinic: 'Jurong Clinic', clinic_id: 'jurong-clinic' }
    };

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    
    console.log('Booking form loaded');
    console.log('URL parameters:', Object.fromEntries(urlParams.entries()));
    
    // Check if required parameters are present
    const requiredParams = ['dentist', 'dentistName', 'date', 'time'];
    const missingParams = requiredParams.filter(param => !urlParams.get(param));
    
    console.log('Required params:', requiredParams);
    console.log('Missing params:', missingParams);
    
    if (missingParams.length > 0) {
      // Show error message and redirect back to schedule
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('errorText').textContent = `Missing: ${missingParams.join(', ')}. Please select your appointment details first.`;
      
      // Redirect back to schedule page after 3 seconds
      setTimeout(() => {
        window.location.href = 'schedule.html';
      }, 3000);
    } else {
      // Populate the form with the selected data
      const dentistId = urlParams.get('dentist');
      const dentistName = urlParams.get('dentistName');
      const date = urlParams.get('date');
      const time = urlParams.get('time');
      
      // Auto-assign clinic based on dentist, with fallback to URL parameter
      const clinicInfo = dentistClinicMapping[dentistName] || { 
        clinic: urlParams.get('clinic') || 'Unknown', 
        clinic_id: urlParams.get('clinic') || 'unknown' 
      };
      
      // Update the summary display
      document.getElementById('selectedDentist').textContent = dentistName;
      document.getElementById('selectedDate').textContent = new Date(date).toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      document.getElementById('selectedTime').textContent = time;
      document.getElementById('selectedClinic').textContent = clinicInfo.clinic;
      
      // Populate hidden form fields
      document.getElementById('dentistId').value = dentistId;
      document.getElementById('dentistName').value = dentistName;
      document.getElementById('clinicId').value = clinicInfo.clinic_id;
      document.getElementById('clinicName').value = clinicInfo.clinic;
      document.getElementById('appointmentDate').value = date;
      document.getElementById('appointmentTime').value = time;
    }
    
    // Form validation and submit button state
    function updateSubmitButton() {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const privacy = document.getElementById('privacy').checked;
      const terms = document.getElementById('terms').checked;
      
      const isValid = firstName && lastName && email && phone && privacy && terms;
      document.getElementById('submitBtn').disabled = !isValid;
    }
    
    // Add event listeners for form validation
    document.getElementById('firstName').addEventListener('input', updateSubmitButton);
    document.getElementById('lastName').addEventListener('input', updateSubmitButton);
    document.getElementById('email').addEventListener('input', updateSubmitButton);
    document.getElementById('phone').addEventListener('input', updateSubmitButton);
    document.getElementById('privacy').addEventListener('change', updateSubmitButton);
    document.getElementById('terms').addEventListener('change', updateSubmitButton);
    
    // Form submission handling
    document.getElementById('bookingForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Disable submit button
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';
      
      // Prepare form data
      const formData = new FormData(this);
      
      // Convert form data to new API format
      const bookingData = {
        appointment: {
          dentistId: formData.get('dentistId'),
          dentistName: formData.get('dentistName'),
          clinicId: formData.get('clinicId'),
          clinicName: formData.get('clinicName'),
          serviceCode: formData.get('service'),
          serviceLabel: document.getElementById('service').selectedOptions[0].text,
          experienceCode: formData.get('experience'),
          experienceLabel: document.getElementById('experience').selectedOptions[0].text,
          dateIso: formData.get('appointmentDate'),
          time24: formData.get('appointmentTime')
        },
        patient: {
          firstName: formData.get('firstName'),
          lastName: formData.get('lastName'),
          email: formData.get('email'),
          phone: formData.get('phone'),
          notes: formData.get('notes')
        },
        consent: {
          agreePolicy: formData.get('privacy') === 'on',
          agreeTerms: formData.get('terms') === 'on'
        }
      };
      
      // Submit to new API endpoint
      fetch('/SmileBright/api/booking/create.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(bookingData)
      })
      .then(async response => {
        const text = await response.text();
        let data;
        
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.error('Non-JSON response:', text);
          alert(`Booking failed (non-JSON, status ${response.status}). First 200 chars:\n` + text.slice(0, 200));
          throw e;
        }
        
        if (data.ok) {
          // Store booking data in localStorage for success page
          localStorage.setItem('lastBooking', JSON.stringify({
            referenceId: data.referenceId,
            bookingId: data.bookingId,
            dentistName: bookingData.appointment.dentistName,
            clinicName: bookingData.appointment.clinicName,
            serviceLabel: bookingData.appointment.serviceLabel,
            dateIso: bookingData.appointment.dateIso,
            time24: bookingData.appointment.time24
          }));
          
          // Navigate to success page using redirectUrl
          window.location.href = data.redirectUrl;
        } else {
          throw new Error(data.error || data.message || 'Booking failed');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Booking failed: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Confirm Booking';
      });
    });
    
    // Mobile menu toggle
    function toggleMobileMenu() {
      const navMenu = document.getElementById('navMenu');
      navMenu.classList.toggle('active');
    }
    
    // Dropdown toggle for mobile/touch devices
    function toggleDropdown(event, element) {
      if (window.innerWidth <= 900 || 'ontouchstart' in window) {
        event.preventDefault();
        const navItem = element.parentElement;
        const wasActive = navItem.classList.contains('active');
        
        document.querySelectorAll('.nav-item.active').forEach(item => {
          if (item !== navItem) {
            item.classList.remove('active');
            item.querySelector('.nav-link')?.setAttribute('aria-expanded', 'false');
          }
        });
        
        navItem.classList.toggle('active');
        element.setAttribute('aria-expanded', !wasActive);
      }
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.nav-item')) {
        document.querySelectorAll('.nav-item.active').forEach(item => {
          item.classList.remove('active');
          item.querySelector('.nav-link')?.setAttribute('aria-expanded', 'false');
        });
      }
    });
    
  </script>
  
  <div id="site-footer"></div>
  <script src="../js/footer.js"></script>
</body>
</html>